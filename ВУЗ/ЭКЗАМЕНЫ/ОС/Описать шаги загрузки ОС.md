**TLDR:**
![[os_boot.png]]

## 1. BIOS 
>[!info] Basic I/O System
>набор микропрограмм загруженных на специальный чип на материнсокй плате.
* Отвечает за базовый ввод/вывод данных с устройств/на устройства
	* Загрузка RAM (TCM)
		TCM (tightly coupled memory) - маленький участок памяти, расположенный очень близко к процессору и используемый им для загрузки оперативной памяти (понять ее тип, тайминги, разрядность, синхронизировать плашки, если возможно). В некоторых микроархитектурах вместо TCM используется кеш, а например, в SCR1 есть TCM и нет кеша. Имеет место некоторый зоопарк.
* Проверка работы электронники, POST (Power-On-Self-Test)
* Запускает загрузчик, например MBR (позиция в памяти на HDD предопределена, например, в 1-м секторе загрузочного диска)
* Передает управление MBR


> [!info] UEFI (Unified Extensible Firmware Interface)
> is a specification for x86, x86-64, ARM, and Itanium platforms that defines a software interface between the operating system and the platform firmware/BIOS.

>[!info] Унифицированный расширяемый интерфейс программного обеспечения
>Прослойка между ОС и микропрограммами

### Отличия UEFI vs BIOS

| Критерий                  | UEFI                        | BIOS                               |
| ------------------------- | --------------------------- | ---------------------------------- |
| Интерфейс                 | Графический, поддержка мыши | Текстовый, управление с клавиатуры |
| Таблица разделов          | Использует GPT              | Использует MBR                     |
| Максимальный размер диска | >2 ТБ (18 ЭБ)               | До 2 ТБ                            |
| Скорость загрузки         | Быстрее + есть Secure Boot  | Медленнее, без Secure Boot         |
| Разрядность               | Поддержка 32- и 64-бит      | В основном 16-бит                  |

## 2. MBR

>[!info] Master Boot Record
>код и данные на энергонезависимом хранителе, которые необходимы для загрузки ОС

![[mbr.png]]

* Занимает меньше, чем 512 байтов
* Соддержит информацию о GRUB
* Загружает и выполняет GRUB
* хранит информацию, позволяющую описать разделы на компьютере

### Структура MBR:
* 446 байт - код загрузочника
* 64 байта - таблица основных разделов (Primary)
* 2 байта - сигнатура (подпись). Должна быть 55AAh

> Если сигнатура не равна 55AAh, значит, MBR поврежден. В MBR процесс загрузки тесно связан с разделами диска, так как хранятся они «вместе».

### Данные в partion table

![[mbr_partion_table.png]]
На описание количества секторов в разделе отводится 4 байта, следовательно количество секторов ограничено величиной 2^32, где степень - количество бит описания (4 байта = 32 бит). Поскольку размер сектора равен 512 байт, то максимальный размер раздела составляет 2^32 * 512 = 2 ТБ. Тем самым мы получаем техническое ограничение на 2 ТБ, его не обойти, но есть GPT.


### GPT

> [!info] GPT (GUID Partion Table) 
> как MBR, отвечает за создание и организацию разделов на жестких дисках. В отличие от MBR интерфейс прошивки GPT поддерживает UEFI с быстрой загрузкой, большей емкостью разделов и большим количеством разделов

Также как и MBR, GPT сохраняет основные данные диска, включая разделы и объемы, в секторе с адресом логического блока (Logical Block Address, LBA), равным 1. Разнцица в том, что даже при использовании схемы разделов GPT на диске должен сохраняться сектор для совместимости с MBR и BIOS, поэтому технически первый сектор диска по-прежнему предназначен для MBR и не может использоваться в качестве держателя ключевых данных для GPT. Этот сектор называется LBA 0, следующий же сектор имеет название LBA 1. 

#### Преимущества GPT над MBR
| Критерий                  | GPT                                                  | MBR                      |
| ------------------------- | ---------------------------------------------------- | ------------------------ |
| Максимальный размер диска | До 18 ЭБ (эксабайты)                                 | До 2 ТБ                  |
| Количество разделов       | До 128 разделов без расширенного                     | До 4 основных разделов   |
| Надёжность хранения       | Данные и копии таблицы в нескольких местах           | Все данные в одном месте |
| Восстановление            | Есть резервная копия таблицы                         | Резервной копии нет      |
| Скорость загрузки         | Быстрее благодаря UEFI                               | Медленнее (BIOS)         |
| Поддержка технологий      | Работает с UEFI, поддерживает современные устройства | Ориентирован на BIOS     |
| Обратная совместимость    | Может работать с BIOS                                | Ограничена BIOS          |

## 3. GRUB
>[!info] Grand Unified Bootloader
>Загрузчик ОС от GNU Project

Одной из главных целей GRUB есть предоставление возможности варьирования и размещения нескольких операционных систем на одной машине, и при необходимости загружать любую из них на выбор. + конечно гибкость в настройке параметров системы при загрузке.
* Если несколько ядер - можно выбрать, какое загрузить
* Конфигурационный файл GRUB'a содержит путь к ядру и initrd
* Дает возможность загрузить предыдущую версию ядра, если это дало сбой
* По умолчанию GRUB2 предоставляет предзагрузочное меню установленных ядер, включая опцию rescue и, если настроено, опцию recovery

### initrd (Initial RAM disk) + initramfs (Initial RAM File System)

>[!info] initrd
>временная файловая система, которая используется при начальной загрузке.

В образе initrd содержится необходимый минимум исполняемых и системных файлов для осуществления второй стадии загрузки linux. В зависимости от версии linux, которую вы используете, различаются методы создания initrd

### initrd vs initramfs

initrd представляет собой монтируемый файловый образ, который работает как временная корневая файловая система. Initramfs, напротив, это архив (обычно в формате cpio), который распаковывается непосредственно в память и не требует монтирования. 

Основные задачи обоих механизмов  - обеспечить ядру доступ к драйверам и утилитам, необходимые для работы с оборудованием (например, с дисковыми устройствами или файловыми системами), до того как загрузится основная система.

## 4. Kernel
![[linux_kernel.png]]

Факты:
* Монтируется в режиме read-only для того, чтобы не повредить данные, если файловая система повреждена и защищает от сбоев (потеря питания и тд) в процессе самой загрузки
* Грузит драйверы, init
* Ядро и связанные с ним файлы находятся в катологе `/boot`. Файлы ядра (compressed kernel and is bootable) можно идентифицировать, так как все они имеют имена, начинающиеся с vmlinuz.
* В `dmesg` можно увидеть записи о маппинге DMA (Direct Memory Access) в физическую память.
* `/proc/iomem` - чтобы посмотреть маппинг памяти для каждого физического устройства. (1 колонка - range адресов, 2 колонка - тип памяти, который будет там находится)

Пример:
```
00000000-0009fbff : System RAM 
0009fc00-0009ffff : reserved 
000a0000-000bffff : Video RAM area 
000c0000-000c7fff : Video ROM 
000f0000-000fffff : System ROM 
00100000-07ffffff : System RAM 
00100000-00291ba8 : Kernel code 
00291ba9-002e09cb : Kernel data
```

* Так как файловые системы еще не смонтированы, ядро при запуске  использует временную файловую систему из файла `initrd.img`, для того чтобы запуститься полностью. После извлечения оно загружает инициализацию операционной системы - systemd (PID 1) и передает ей управление.
### Systemd
> [!info] Systemd
> менеджер системы и служб в Linux. Основная задача - сделать так, чтобы система работала предсказуемо и надежно.

Systemd позволяет автоматически перезапускать программы при сбоях, следить за их зависимостями и удобно управлять их состоянием с помощью команд.

Является основным родителем для всех процессов, имеет первый номер процесса (PID 1) и отвечает за доведения хоста Linux до состояния, в котором можно выполнять работу. 

Монтирует файловые системы, как определено в файле `/etc/fstab`, включая любые файлы подкачки или разделы. На этом этапе он уже может получить доступ к файлам конфигурации, расположенным в `/etc`, включая свои конфигурационные файлы.